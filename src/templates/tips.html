{% extends "base.html" %}
{% load markdownify %}
{% block title %}–ü–æ–ª–µ–∑–Ω—ã–µ –°–æ–≤–µ—Ç—ã{% endblock %}
{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title">–ü–æ–ª–µ–∑–Ω—ã–µ –°–æ–≤–µ—Ç—ã</h1>
        <div class="box mb-6">
            <form method="GET" action="{% url 'tips' %}" id="tips-filter-form">
                <div class="field is-horizontal">
                    <div class="field-body">
                        <div class="field">
                            <label class="label" for="search-input">–ü–æ–∏—Å–∫:</label>
                            <div class="control">
                                <input 
                                    class="input" 
                                    type="text" 
                                    id="search-input"
                                    name="q" 
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞..." 
                                    value="{{ search_query }}">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">–¢–µ–≥–∏:</label>
                            <div class="control">
                                <div class="tags">
                                    {% for tag in all_tags %}
                                    <label class="checkbox tag is-medium" style="margin-right: 0.5rem;">
                                        <input type="checkbox" name="tags" value="{{ tag.id }}"
                                            {% if tag.id in selected_tag_ids %}checked{% endif %}
                                            style="margin-right: 0.25em;">
                                        {{ tag.name }}
                                    </label>
                                    {% empty %}
                                    <p class="help">–¢–µ–≥–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field is-grouped is-grouped-right">
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            <span class="icon"><i class="fas fa-filter"></i></span>
                            <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                        </button>
                        <a href="{% url 'tips' %}" class="button is-light">
                            <span class="icon"><i class="fas fa-times"></i></span>
                            <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–æ–≤–µ—Ç–æ–≤ -->
        {% if tips %}
        <div class="columns is-multiline">
            {% for tip in tips %}
            <div class="column is-one-third">
                <div class="card">
                    <div class="card-content">
                        <p class="title is-4">{{ tip.title }}</p>
                        <div class="subtitle is-6 has-text-grey mb-4">
                            <div class="icon-text mb-2">
                                <span class="icon">
                                    <i class="fas fa-user"></i>
                                </span>
                                <span>{{ tip.author.username }}</span>
                            </div>
                            <div class="icon-text">
                                <span class="icon">
                                    <i class="far fa-calendar-alt"></i>
                                </span>
                                <span>{{ tip.pub_date|date:"d.m.Y H:i" }}</span>
                            </div>
                            <div class="icon-text">
                                <span class="icon">
                                    <i class="fas fa-eye"></i>
                                </span>
                                <span>{{ tip.views_count }}</span>
                            </div>
                            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ —Å–æ–≤–µ—Ç–∞ -->
                            {% if tip.tags.all %}
                            <div class="tags are-small mt-2">
                                {% for tag in tip.tags.all %}
                                    <span class="tag is-light">{{ tag.name }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="content">
                            <div class="markdown-content">
                                {{ tip.content|markdownify|truncatechars_html:150 }}
                            </div>
                        </div>
                        <div class="mt-4 buttons are-small">
                            <a href="{% url 'tip_detail' tip.pk %}" class="button is-primary">
                                <span class="icon">
                                    <i class="fas fa-book-open"></i>
                                </span>
                                <span>–ß–∏—Ç–∞—Ç—å</span>
                            </a>
                            {% if tip.external_link %}
                            <a href="{{ tip.external_link }}" class="button is-primary is-outlined" target="_blank" rel="noopener noreferrer">
                                <span class="icon">
                                    <i class="fas fa-external-link-alt"></i>
                                </span>
                                <span>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <nav class="pagination is-centered my-6" role="navigation" aria-label="pagination">
            {% if tips.has_previous %}
                <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page=1" class="pagination-previous">–ü–µ—Ä–≤–∞—è</a>
                <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page={{ tips.previous_page_number }}" class="pagination-previous">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            {% else %}
                <a class="pagination-previous" disabled>–ü–µ—Ä–≤–∞—è</a>
                <a class="pagination-previous" disabled>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
            {% endif %}
            {% if tips.has_next %}
                <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page={{ tips.next_page_number }}" class="pagination-next">–°–ª–µ–¥—É—é—â–∞—è</a>
                <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page={{ tips.paginator.num_pages }}" class="pagination-next">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
            {% else %}
                <a class="pagination-next" disabled>–°–ª–µ–¥—É—é—â–∞—è</a>
                <a class="pagination-next" disabled>–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
            {% endif %}
            <ul class="pagination-list">
                {% for num in tips.paginator.page_range %}
                    {% if tips.number == num %}
                        <li>
                            <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page={{ num }}" class="pagination-link has-background-primary" aria-label="–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ num }}" aria-current="page">{{ num }}</a>
                        </li>
                    {% else %}
                        <li>
                            <a href="?q={{ search_query|urlencode }}{% for tag_id in selected_tag_ids %}&tags={{ tag_id }}{% endfor %}&page={{ num }}" class="pagination-link" aria-label="–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É {{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </nav>
        {% else %}
        <div class="box has-text-centered">
            <p class="subtitle">üì≠ –°–æ–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>
             <a href="{% url 'tips' %}" class="button is-primary mt-4">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}