{% extends "base.html" %}
{% load markdownify %}

{% block title %}–ü–æ–ª–µ–∑–Ω—ã–µ –°–æ–≤–µ—Ç—ã{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <nav class="breadcrumb has-succeeds-separator" aria-label="breadcrumbs">
            <ul>
                <li>
                    <a href="/">
                        <span class="icon is-small"><i class="fas fa-home"></i></span>
                        <span>–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
                <li class="is-active">
                    <a href="#" aria-current="page">
                        <span class="icon is-small"><i class="far fa-lightbulb"></i></span>
                        <span>–°–æ–≤–µ—Ç—ã</span>
                    </a>
                </li>
            </ul>
        </nav>

        <h1 class="title is-2 mb-6 theme-aware-title">üí° –ü–æ–ª–µ–∑–Ω—ã–µ –°–æ–≤–µ—Ç—ã</h1>

        <div class="box mb-6">
            <form method="GET" action="{% url 'tips' %}" id="tips-filter-form">
                <div class="columns is-multiline">
                    
                    <div class="column is-12-mobile is-7-tablet">
                        <div class="field">
                            <label class="label">–ü–æ–∏—Å–∫</label>
                            <div class="control has-icons-left">
                                <input class="input" type="text" id="search-input" name="q" 
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—É—Ç–µ—Ä..." 
                                       value="{{ search_query }}">
                                <span class="icon is-small is-left"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>

                    <div class="column is-12-mobile is-5-tablet">
                         <div class="field">
                            <label class="label">–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º</label>
                            <div class="control">
                                <div class="tags are-medium">
                                    {% for tag in all_tags %}
                                    <label class="tag is-clickable {% if tag.id in selected_tag_ids %}is-primary{% else %}is-light{% endif %}" 
                                           style="cursor: pointer; user-select: none;">
                                        <input type="checkbox" name="tags" value="{{ tag.id }}" 
                                               {% if tag.id in selected_tag_ids %}checked{% endif %} 
                                               style="display: none;"
                                               onchange="this.form.submit()">
                                        {{ tag.name }}
                                    </label>
                                    {% empty %}
                                    <p class="help">–¢–µ–≥–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã.</p>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field is-grouped is-grouped-right mt-4">
                    <div class="control">
                        <button type="submit" class="button is-primary">
                            <span class="icon"><i class="fas fa-filter"></i></span>
                            <span>–ù–∞–π—Ç–∏</span>
                        </button>
                    </div>
                    <div class="control">
                        <a href="{% url 'tips' %}" class="button is-light">
                            <span class="icon"><i class="fas fa-undo"></i></span>
                            <span>–°–±—Ä–æ—Å–∏—Ç—å</span>
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <div class="columns">
            <div class="column is-12-mobile is-9-desktop">
                {% if tips %}
                <div class="columns is-multiline">
                    {% for tip in tips %}
                    <div class="column is-12-mobile is-6-tablet is-4-desktop is-flex">
                        
                        <div class="card resource-card is-flex-grow-1">
                            <div class="card-content">
                                <p class="title is-5 mb-3">
                                    <a href="{% url 'tip_detail' tip.pk %}" class="has-text-dark">
                                        {{ tip.title }}
                                    </a>
                                </p>
                                
                                <div class="level is-mobile mb-3 is-size-7 has-text-grey">
                                    <div class="level-left">
                                        <div class="level-item">
                                            <span class="icon is-small mr-1"><i class="far fa-calendar-alt"></i></span>
                                            {{ tip.pub_date|date:"d.m.y" }}
                                        </div>
                                        <div class="level-item">
                                            <span class="icon is-small mr-1"><i class="fas fa-eye"></i></span>
                                            {{ tip.views_count }}
                                        </div>
                                    </div>
                                </div>

                                {% if tip.tags.all %}
                                    <div class="tags are-small mb-3">
                                        {% for tag in tip.tags.all|slice:":3" %}
                                            <a href="{% url 'tips' %}?tags={{ tag.id }}" class="tag is-light" style="text-decoration: none;">
                                                {{ tag.name }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                                <div class="content is-small mb-0" style="overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                                    {{ tip.content|markdownify|striptags }}
                                </div>
                            </div>
                            
                            <footer class="card-footer mt-auto">
                                <a href="{% url 'tip_detail' tip.pk %}" class="card-footer-item has-text-primary has-text-weight-medium">
                                    –ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ
                                </a>
                                {% if tip.external_link %}
                                <a href="{{ tip.external_link }}" class="card-footer-item has-text-grey" target="_blank">
                                    <span class="icon"><i class="fas fa-external-link-alt"></i></span>
                                </a>
                                {% endif %}
                            </footer>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <nav class="pagination is-centered is-rounded my-6" role="navigation" aria-label="pagination">
                    {% if tips.has_previous %}
                        <a href="?{{ query_string }}&page={{ tips.previous_page_number }}" class="pagination-previous">
                            <span class="icon"><i class="fas fa-chevron-left"></i></span> –ù–∞–∑–∞–¥
                        </a>
                    {% else %}
                        <a class="pagination-previous" disabled>–ù–∞–∑–∞–¥</a>
                    {% endif %}

                    {% if tips.has_next %}
                        <a href="?{{ query_string }}&page={{ tips.next_page_number }}" class="pagination-next">
                            –í–ø–µ—Ä–µ–¥ <span class="icon"><i class="fas fa-chevron-right"></i></span>
                        </a>
                    {% else %}
                        <a class="pagination-next" disabled>–í–ø–µ—Ä–µ–¥</a>
                    {% endif %}

                    <ul class="pagination-list">
                        {% for num in tips.paginator.page_range %}
                            {% if tips.number == num %}
                                <li><a class="pagination-link is-current" aria-label="Page {{ num }}">{{ num }}</a></li>
                            {% elif num > tips.number|add:'-3' and num < tips.number|add:'3' %}
                                <li><a href="?{{ query_string }}&page={{ num }}" class="pagination-link">{{ num }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </nav>
                
                {% else %}
                <div class="notification is-light has-text-centered">
                    <p class="title is-5">–°–æ–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üòî</p>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã.</p>
                </div>
                {% endif %}
            </div>

            <div class="column is-12-mobile is-3-desktop">
                <div class="box" style="position: sticky; top: 20px;"> 
                    <h2 class="title is-5 mb-4">
                        <span class="icon-text">
                            <span class="icon has-text-warning"><i class="fas fa-fire"></i></span>
                            <span>–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</span>
                        </span>
                    </h2>
                    <aside class="menu">
                        <ul class="menu-list">
                            {% for pop_tip in popular_tips %}
                            <li>
                                <a href="{% url 'tip_detail' pop_tip.pk %}" class="is-size-6 py-2">
                                    {{ pop_tip.title|truncatechars:100 }}
                                    <br>
                                    <span class="is-size-7 has-text-grey">
                                        <i class="fas fa-eye mr-1"></i> {{ pop_tip.views_count }}
                                    </span>
                                </a>
                            </li>
                            {% empty %}
                            <li><p class="is-size-7 has-text-grey">–ü–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p></li>
                            {% endfor %}
                        </ul>
                    </aside>
                </div>
            </div> 
        </div> 
    </div>
</section>
{% endblock %}